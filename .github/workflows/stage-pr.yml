on:
    pull_request:
        branches:
            - stage

jobs:
    build-test-and-deploy:
        name: Run Tests and Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2.0.0
              with:
                  ref: ${{ github.event.pull_request.head.sha }}
            - name: Use Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ env.NODE_VERSION }}
            - name: Find and Replace CLIENT_SECRET_TOKEN and CLIENT_ID_TOKEN
              uses: cschleiden/replace-tokens@v1
              with:
                files: '["**/*.ts"]'
              env:
                CLIENT_SECRET_TOKEN: ${{ secrets.AZURE_ADAPTIVECMS_STAGE_CLIENT_SECRET }}
                CLIENT_ID_TOKEN: ${{ secrets.AZURE_ADAPTIVECMS_STAGE_CLIENT_ID }}
            - name: Find and Replace http://localhost:5000
              uses: cschleiden/replace-tokens@v1
              with:
                tokenPrefix: 'http://'
                tokenSuffix: ':5000'
                files: '["**/*.ts"]'
              env:
                localhost: https://adaptivecms-stage.azurewebsites.net
            - name: Adaptive Cards Templating Service Test
              run: |
                  cd private-templates-service/adaptivecards-templating-service
                  npm install
                  npm run test
                  cd ..
            - name: Frontend Jest Test
              run: |
                  cd private-templates-service/adaptivecards-templating-client/typescript
                  npm install
                  npm run build
                  sudo npm link
                  cd ../../client
                  npm link adaptive-templating-service-typescript-node
                  npm install
                  cd src 
                  npm link adaptive-templating-service-typescript-node
                  cd ..
                  npm run test
                  cd ..
            - name: Install in server
              run: |
                  cd private-templates-service/adaptivecards-templating-service
                  sudo npm link
                  cd ../server
                  npm link adaptivecards-templating-service
                  npm install
                  cd ..
            - name: Create test build
              if: success()
              run: |
                  cd private-templates-service/client
                  npm run build:staging --if-present
                  cd ../server
                  npm run deploy
                  